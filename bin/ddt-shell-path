#!/usr/bin/env php
<?php declare(strict_types=1);
$showErrors = true;
$cli = require_once(__DIR__.'/../src/init.php');

$config     = new Config();
$systemPath = new SystemPath($config);

if($cli->getArg('get')){
	Text::print("Installed Tools: ".$config->getToolsPath()."\n");
}

if($newPath = $cli->getArg('install')){
    $toolPath = $config->getToolsPath();
    $systemPath->uninstall($toolPath);

    // Detect bad paths and ignore them
    $newPath = is_dir($newPath) ? realpath($newPath) : dirname(__DIR__);

    $script = $cli->getScript(false);

    if(!is_dir("$newPath/bin") || !file_exists("$newPath/bin/$script")){
        Script::failure(Text::write(<<<EOF
        {red}Sanity checks for this path failed. The following items are required to be valid:
        Folder: $newPath/bin
        File: $newPath/bin/$script{end}
EOF
        ));
    }

    $systemPath->install($newPath);

    // We override this value because now we've updated the path, we should test
    $cli->setArg('test', true);
}

if($cli->hasArg('uninstall')){
	$toolPath = $config->getToolsPath();
	$systemPath->uninstall($toolPath);
}

if($cli->hasArg('test')){
    $toolPath = $config->getToolsPath();

    if($systemPath->test($toolPath, $cli->getScript(false))){
        print(Text::box("The path was successfully installed, you might need to open a new terminal to see the effects", "black", "green"));
    }else{
        print(Text::box("The tool '" . basename($cli->getScript()) . "' could not set the shell path successfully installed. Please report this error", "white", "red"));
        exit(1);
    }
}

exit(0);
